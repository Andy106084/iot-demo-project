name: SonarQube Security Analysis
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    env:
      BUILD_WRAPPER_OUT_DIR: build_wrapper_output_directory # Directory where build-wrapper output will be placed
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: Install Build Wrapper
        uses: SonarSource/sonarqube-scan-action/install-build-wrapper@v6
      - name: Run Build Wrapper
        run: |
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} gcc main.c -o main
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          args: >
            --define "sonar.cfamily.compile-commands=${{ env.BUILD_WRAPPER_OUT_DIR }}/compile_commands.json"
      - name: Check Quality Gate
        run: |
          echo "Quality Gate status will be checked by SonarQube scan step"
          echo "If Quality Gate fails, the workflow will fail automatically"

      # Email é€šçŸ¥æ­¥é©Ÿ - ç•¶æª¢æ¸¬åˆ°å®‰å…¨å•é¡Œæ™‚ç™¼é€
      - name: Send Email Notification on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ SonarQube æª¢æ¸¬åˆ°å®‰å…¨å•é¡Œ - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_TO }}
          from: SonarQube Security Bot
          body: |
            ## ğŸš¨ å®‰å…¨å•é¡Œæª¢æ¸¬å ±å‘Š

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Commit Message:** ${{ github.event.head_commit.message }}

            ---

            ### âŒ SonarQube Quality Gate å¤±æ•—

            æ‚¨çš„ä»£ç¢¼æœªé€šé SonarQube å®‰å…¨æª¢æŸ¥ã€‚å¯èƒ½çš„å•é¡ŒåŒ…æ‹¬ï¼š
            - ğŸ”´ Security Hotspotsï¼ˆéœ€è¦å¯©æŸ¥çš„å®‰å…¨æ•æ„Ÿä»£ç¢¼ï¼‰
            - ğŸ”´ ç¡¬ç·¨ç¢¼æ†‘è­‰ï¼ˆå¯†ç¢¼ã€API Keysï¼‰
            - ğŸ”´ Buffer Overflow é¢¨éšª
            - ğŸ”´ ä½¿ç”¨ä¸å®‰å…¨çš„å‡½æ•¸ï¼ˆstrcpy, gets, sprintf ç­‰ï¼‰

            ---

            ### ğŸ“Š è©³ç´°å ±å‘Š

            **SonarCloud å ±å‘Šï¼š**
            https://sonarcloud.io/dashboard?id=Andy106084_iot-demo-project

            **GitHub Actions é‹è¡Œï¼š**
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Commit è©³æƒ…ï¼š**
            ${{ github.event.head_commit.url }}

            ---

            ### ğŸ”§ ä¸‹ä¸€æ­¥è¡Œå‹•

            1. æŸ¥çœ‹ SonarCloud ä¸Šçš„è©³ç´°å•é¡Œåˆ—è¡¨
            2. ä¿®å¾©æ‰€æœ‰å®‰å…¨å•é¡Œ
            3. é‡æ–°æäº¤ä»£ç¢¼
            4. ç­‰å¾… SonarQube æª¢æŸ¥é€šéå¾Œæ‰èƒ½åˆä½µ

            ---

            æ­¤éƒµä»¶ç”± GitHub Actions è‡ªå‹•ç™¼é€ã€‚
